<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Service Tech">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>Service Technician Data Capture - Offline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .offline-badge {
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-top: 10px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-info {
            background: #17a2b8;
        }

        video, img, audio {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }

        .preview-container {
            margin-top: 15px;
            text-align: center;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .submit-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 30px;
        }

        .submit-section button {
            font-size: 1.1em;
            padding: 12px 30px;
        }

        .captured-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .captured-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #28a745;
            border: 1px solid #28a745;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .captured-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin: 0;
        }

        #camera-preview {
            display: none;
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }

        .emoji {
            font-size: 1.5em;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .saved-reports {
            margin-top: 20px;
        }

        .report-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .report-item h3 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .report-item .meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .report-actions button {
            font-size: 0.9em;
            padding: 8px 16px;
        }

        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .modal-close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Service Technician Data Capture</h1>
            <p>Document your service calls with photos, videos, audio, and detailed notes</p>
            <div class="offline-badge">‚ö° Offline Mode</div>
        </div>

        <div class="content">
            <!-- Structured Text Form -->
            <div class="section">
                <h2><span class="emoji">üìù</span> Service Information</h2>

                <div class="form-group">
                    <label for="serviceType">Service Type</label>
                    <select id="serviceType">
                        <option value="">Select service type</option>
                        <option value="installation">Installation</option>
                        <option value="diagnostics">Diagnostics</option>
                        <option value="repair">Repair</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="inspection">Inspection</option>
                        <option value="emergency">Emergency</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="make">Make</label>
                    <input type="text" id="make" placeholder="Equipment make">
                </div>
                
                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" id="model" placeholder="Equipment model">
                </div>

                <div class="form-group">
                    <label for="failure">Failure</label>
                    <textarea id="failure" placeholder="Issue"></textarea>
                </div>

                <div class="form-group">
                    <label for="correction">Correction</label>
                    <textarea id="correction" placeholder="Correction"></textarea>
                </div>
            </div>

            <!-- Photo Capture -->
            <div class="section">
                <h2><span class="emoji">üì∑</span> Photo Capture</h2>
                <button id="startCamera">Start Camera</button>
                <button id="capturePhoto" style="display:none;">Take Photo</button>
                <button id="stopCamera" class="btn-secondary" style="display:none;">Stop Camera</button>
                <div style="margin-top: 10px;">
                    <label for="photoUpload" class="btn-info" style="display: inline-block; cursor: pointer;">
                        Or Choose from Camera/Gallery
                    </label>
                    <input type="file" id="photoUpload" accept="image/*" capture="environment" style="display: none;">
                </div>

                <div class="preview-container">
                    <video id="camera-preview" autoplay playsinline></video>
                    <canvas id="photo-canvas" style="display:none;"></canvas>
                </div>

                <div class="captured-items" id="photo-list"></div>
                <div id="photo-status" class="status-message"></div>
            </div>

            <!-- Video Recording -->
            <div class="section">
                <h2><span class="emoji">üé•</span> Video Recording</h2>
                <button id="startVideo">Start Recording</button>
                <button id="stopVideo" class="btn-danger" style="display:none;">
                    <span class="recording-indicator"></span>Stop Recording
                </button>
                <div style="margin-top: 10px;">
                    <label for="videoUpload" class="btn-info" style="display: inline-block; cursor: pointer;">
                        Or Choose Video File
                    </label>
                    <input type="file" id="videoUpload" accept="video/*" capture="environment" style="display: none;">
                </div>

                <div class="preview-container" id="video-preview-container"></div>
                <div class="captured-items" id="video-list"></div>
                <div id="video-status" class="status-message"></div>
            </div>

            <!-- Audio Recording -->
            <div class="section">
                <h2><span class="emoji">üé§</span> Audio Recording</h2>
                <button id="startAudio">Start Recording</button>
                <button id="stopAudio" class="btn-danger" style="display:none;">
                    <span class="recording-indicator"></span>Stop Recording
                </button>
                <div style="margin-top: 10px;">
                    <label for="audioUpload" class="btn-info" style="display: inline-block; cursor: pointer;">
                        Or Choose Audio File
                    </label>
                    <input type="file" id="audioUpload" accept="audio/*" capture="user" style="display: none;">
                </div>

                <div class="preview-container" id="audio-preview-container"></div>
                <div class="captured-items" id="audio-list"></div>
                <div id="audio-status" class="status-message"></div>
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <div id="submit-status" class="status-message"></div>
                <button id="submitAll" class="btn-success">Save Service Report</button>
                <button id="viewReports" class="btn-info">View Saved Reports (<span id="reportCount">0</span>)</button>
            </div>

            <!-- Saved Reports Section -->
            <div class="section saved-reports" id="savedReportsSection" style="display: none;">
                <h2><span class="emoji">üìã</span> Saved Reports</h2>
                <div id="reportsList"></div>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="exportAllData" class="btn-info">Export All Data as JSON</button>
                    <button id="clearAllData" class="btn-danger">Clear All Saved Reports</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing report details -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // IndexedDB setup for storing media files
        let db;
        const DB_NAME = 'ServiceTechDB';
        const STORE_PHOTOS = 'photos';
        const STORE_VIDEOS = 'videos';
        const STORE_AUDIO = 'audio';
        const STORE_REPORTS = 'reports';

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains(STORE_PHOTOS)) {
                        db.createObjectStore(STORE_PHOTOS, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_VIDEOS)) {
                        db.createObjectStore(STORE_VIDEOS, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_AUDIO)) {
                        db.createObjectStore(STORE_AUDIO, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_REPORTS)) {
                        db.createObjectStore(STORE_REPORTS, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // Save to IndexedDB
        function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get from IndexedDB
        function getFromIndexedDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get all from IndexedDB
        function getAllFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Delete from IndexedDB
        function deleteFromIndexedDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Global variables
        let cameraStream = null;
        let videoRecorder = null;
        let audioRecorder = null;
        let recordedChunks = [];
        let capturedPhotos = [];
        let capturedVideos = [];
        let capturedAudio = [];

        // Initialize app
        initDB().then(() => {
            console.log('Database initialized');
            updateReportCount();
        }).catch(err => {
            console.error('Failed to initialize database:', err);
            alert('Failed to initialize offline storage. Some features may not work.');
        });

        // Utility functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function addCapturedItem(listId, itemId, filename, type) {
            const list = document.getElementById(listId);
            const item = document.createElement('div');
            item.className = 'captured-item';
            item.innerHTML = `‚úì ${filename} <button onclick="removeItem('${type}', ${itemId}, this.parentElement)">√ó</button>`;
            list.appendChild(item);
        }

        function removeItem(type, itemId, element) {
            const storeName = type === 'photo' ? STORE_PHOTOS : type === 'video' ? STORE_VIDEOS : STORE_AUDIO;
            const array = type === 'photo' ? capturedPhotos : type === 'video' ? capturedVideos : capturedAudio;

            deleteFromIndexedDB(storeName, itemId).then(() => {
                const index = array.indexOf(itemId);
                if (index > -1) array.splice(index, 1);
                element.remove();
                showStatus(`${type}-status`, `${type.charAt(0).toUpperCase() + type.slice(1)} removed`, 'info');
            });
        }

        async function updateReportCount() {
            try {
                const reports = await getAllFromIndexedDB(STORE_REPORTS);
                document.getElementById('reportCount').textContent = reports.length;
            } catch (err) {
                console.error('Error updating report count:', err);
            }
        }

        // Photo Capture
        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                cameraStream = stream;
                const videoElement = document.getElementById('camera-preview');
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';

                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('capturePhoto').style.display = 'inline-block';
                document.getElementById('stopCamera').style.display = 'inline-block';

                showStatus('photo-status', 'Camera started successfully', 'success');
            } catch (err) {
                console.error('Error accessing camera:', err);
                showStatus('photo-status', 'Error accessing camera: ' + err.message, 'error');
            }
        });

        document.getElementById('capturePhoto').addEventListener('click', async () => {
            const videoElement = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');
            const context = canvas.getContext('2d');

            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0);

            canvas.toBlob(async (blob) => {
                try {
                    const timestamp = new Date().toISOString();
                    const filename = `photo_${Date.now()}.jpg`;

                    const id = await saveToIndexedDB(STORE_PHOTOS, {
                        blob: blob,
                        filename: filename,
                        timestamp: timestamp
                    });

                    capturedPhotos.push(id);
                    addCapturedItem('photo-list', id, filename, 'photo');
                    showStatus('photo-status', 'Photo captured successfully!', 'success');
                } catch (err) {
                    console.error('Error saving photo:', err);
                    showStatus('photo-status', 'Error saving photo: ' + err.message, 'error');
                }
            }, 'image/jpeg', 0.9);
        });

        document.getElementById('stopCamera').addEventListener('click', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                document.getElementById('camera-preview').style.display = 'none';
                document.getElementById('startCamera').style.display = 'inline-block';
                document.getElementById('capturePhoto').style.display = 'none';
                document.getElementById('stopCamera').style.display = 'none';
                showStatus('photo-status', 'Camera stopped', 'info');
            }
        });

        // Photo Upload (iPhone fallback)
        document.getElementById('photoUpload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const timestamp = new Date().toISOString();
                const filename = `photo_${Date.now()}.jpg`;

                const id = await saveToIndexedDB(STORE_PHOTOS, {
                    blob: file,
                    filename: filename,
                    timestamp: timestamp
                });

                capturedPhotos.push(id);
                addCapturedItem('photo-list', id, filename, 'photo');
                showStatus('photo-status', 'Photo added successfully!', 'success');

                // Clear input so same file can be selected again
                event.target.value = '';
            } catch (err) {
                console.error('Error saving photo:', err);
                showStatus('photo-status', 'Error saving photo: ' + err.message, 'error');
            }
        });

        // Video Recording
        document.getElementById('startVideo').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: true
                });

                recordedChunks = [];

                const options = { mimeType: 'video/webm;codecs=vp8,opus' };
                videoRecorder = new MediaRecorder(stream, options);

                videoRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                videoRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });

                    try {
                        const timestamp = new Date().toISOString();
                        const filename = `video_${Date.now()}.webm`;

                        const id = await saveToIndexedDB(STORE_VIDEOS, {
                            blob: blob,
                            filename: filename,
                            timestamp: timestamp
                        });

                        capturedVideos.push(id);
                        addCapturedItem('video-list', id, filename, 'video');
                        showStatus('video-status', 'Video saved successfully!', 'success');

                        const videoPreview = document.createElement('video');
                        videoPreview.src = URL.createObjectURL(blob);
                        videoPreview.controls = true;
                        videoPreview.style.maxWidth = '100%';
                        document.getElementById('video-preview-container').innerHTML = '';
                        document.getElementById('video-preview-container').appendChild(videoPreview);
                    } catch (err) {
                        console.error('Error saving video:', err);
                        showStatus('video-status', 'Error saving video: ' + err.message, 'error');
                    }

                    stream.getTracks().forEach(track => track.stop());
                };

                videoRecorder.start();

                const videoPreview = document.createElement('video');
                videoPreview.srcObject = stream;
                videoPreview.autoplay = true;
                videoPreview.muted = true;
                videoPreview.style.maxWidth = '100%';
                document.getElementById('video-preview-container').innerHTML = '';
                document.getElementById('video-preview-container').appendChild(videoPreview);

                document.getElementById('startVideo').style.display = 'none';
                document.getElementById('stopVideo').style.display = 'inline-block';

                showStatus('video-status', 'Recording video...', 'info');
            } catch (err) {
                console.error('Error starting video recording:', err);
                showStatus('video-status', 'Error starting video: ' + err.message, 'error');
            }
        });

        document.getElementById('stopVideo').addEventListener('click', () => {
            if (videoRecorder && videoRecorder.state !== 'inactive') {
                videoRecorder.stop();
                document.getElementById('startVideo').style.display = 'inline-block';
                document.getElementById('stopVideo').style.display = 'none';
            }
        });

        // Video Upload (iPhone fallback)
        document.getElementById('videoUpload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const timestamp = new Date().toISOString();
                const filename = `video_${Date.now()}.${file.name.split('.').pop()}`;

                const id = await saveToIndexedDB(STORE_VIDEOS, {
                    blob: file,
                    filename: filename,
                    timestamp: timestamp
                });

                capturedVideos.push(id);
                addCapturedItem('video-list', id, filename, 'video');
                showStatus('video-status', 'Video added successfully!', 'success');

                // Show preview
                const videoPreview = document.createElement('video');
                videoPreview.src = URL.createObjectURL(file);
                videoPreview.controls = true;
                videoPreview.style.maxWidth = '100%';
                document.getElementById('video-preview-container').innerHTML = '';
                document.getElementById('video-preview-container').appendChild(videoPreview);

                // Clear input
                event.target.value = '';
            } catch (err) {
                console.error('Error saving video:', err);
                showStatus('video-status', 'Error saving video: ' + err.message, 'error');
            }
        });

        // Audio Recording
        document.getElementById('startAudio').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                recordedChunks = [];

                const options = { mimeType: 'audio/webm;codecs=opus' };
                audioRecorder = new MediaRecorder(stream, options);

                audioRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                audioRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });

                    try {
                        const timestamp = new Date().toISOString();
                        const filename = `audio_${Date.now()}.webm`;

                        const id = await saveToIndexedDB(STORE_AUDIO, {
                            blob: blob,
                            filename: filename,
                            timestamp: timestamp
                        });

                        capturedAudio.push(id);
                        addCapturedItem('audio-list', id, filename, 'audio');
                        showStatus('audio-status', 'Audio saved successfully!', 'success');

                        const audioPreview = document.createElement('audio');
                        audioPreview.src = URL.createObjectURL(blob);
                        audioPreview.controls = true;
                        audioPreview.style.maxWidth = '100%';
                        document.getElementById('audio-preview-container').innerHTML = '';
                        document.getElementById('audio-preview-container').appendChild(audioPreview);
                    } catch (err) {
                        console.error('Error saving audio:', err);
                        showStatus('audio-status', 'Error saving audio: ' + err.message, 'error');
                    }

                    stream.getTracks().forEach(track => track.stop());
                };

                audioRecorder.start();

                document.getElementById('startAudio').style.display = 'none';
                document.getElementById('stopAudio').style.display = 'inline-block';

                showStatus('audio-status', 'Recording audio...', 'info');
            } catch (err) {
                console.error('Error starting audio recording:', err);
                showStatus('audio-status', 'Error starting audio: ' + err.message, 'error');
            }
        });

        document.getElementById('stopAudio').addEventListener('click', () => {
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
                document.getElementById('startAudio').style.display = 'inline-block';
                document.getElementById('stopAudio').style.display = 'none';
            }
        });

        // Audio Upload (iPhone fallback)
        document.getElementById('audioUpload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const timestamp = new Date().toISOString();
                const filename = `audio_${Date.now()}.${file.name.split('.').pop()}`;

                const id = await saveToIndexedDB(STORE_AUDIO, {
                    blob: file,
                    filename: filename,
                    timestamp: timestamp
                });

                capturedAudio.push(id);
                addCapturedItem('audio-list', id, filename, 'audio');
                showStatus('audio-status', 'Audio added successfully!', 'success');

                // Show preview
                const audioPreview = document.createElement('audio');
                audioPreview.src = URL.createObjectURL(file);
                audioPreview.controls = true;
                audioPreview.style.maxWidth = '100%';
                document.getElementById('audio-preview-container').innerHTML = '';
                document.getElementById('audio-preview-container').appendChild(audioPreview);

                // Clear input
                event.target.value = '';
            } catch (err) {
                console.error('Error saving audio:', err);
                showStatus('audio-status', 'Error saving audio: ' + err.message, 'error');
            }
        });

        // Submit All Data
        document.getElementById('submitAll').addEventListener('click', async () => {
            const data = {
                service_type: document.getElementById('serviceType').value,
                equipment_id: document.getElementById('equipmentId').value,
                notes: document.getElementById('notes').value,
                photos: capturedPhotos,
                videos: capturedVideos,
                audio: capturedAudio,
                timestamp: new Date().toISOString()
            };

            try {
                const id = await saveToIndexedDB(STORE_REPORTS, data);

                showStatus('submit-status', 'Service report saved successfully! üéâ', 'success');
                updateReportCount();

                setTimeout(() => {
                    if (confirm('Report saved! Would you like to start a new report?')) {
                        document.getElementById('serviceType').value = '';
                        document.getElementById('equipmentId').value = '';
                        document.getElementById('notes').value = '';
                        document.getElementById('photo-list').innerHTML = '';
                        document.getElementById('video-list').innerHTML = '';
                        document.getElementById('audio-list').innerHTML = '';
                        capturedPhotos = [];
                        capturedVideos = [];
                        capturedAudio = [];
                    }
                }, 2000);
            } catch (err) {
                console.error('Error saving report:', err);
                showStatus('submit-status', 'Error saving report: ' + err.message, 'error');
            }
        });

        // View Reports
        document.getElementById('viewReports').addEventListener('click', async () => {
            const reportsSection = document.getElementById('savedReportsSection');
            const reportsList = document.getElementById('reportsList');

            reportsSection.style.display = 'block';
            reportsList.innerHTML = '<p>Loading reports...</p>';

            try {
                const reports = await getAllFromIndexedDB(STORE_REPORTS);

                if (reports.length === 0) {
                    reportsList.innerHTML = '<p>No saved reports yet.</p>';
                    return;
                }

                reportsList.innerHTML = '';

                for (const report of reports.reverse()) {
                    const reportDiv = document.createElement('div');
                    reportDiv.className = 'report-item';

                    const date = new Date(report.timestamp).toLocaleString();

                    reportDiv.innerHTML = `
                        <h3>${report.service_type || 'Unspecified'} - ${report.equipment_id || 'No ID'}</h3>
                        <div class="meta">${date}</div>
                        <p><strong>Notes:</strong> ${report.notes || 'No notes'}</p>
                        <p><strong>Media:</strong> ${report.photos.length} photos, ${report.videos.length} videos, ${report.audio.length} audio files</p>
                        <div class="report-actions">
                            <button onclick="viewReportDetails(${report.id})">View Details</button>
                            <button onclick="exportReport(${report.id})" class="btn-info">Export</button>
                            <button onclick="deleteReport(${report.id})" class="btn-danger">Delete</button>
                        </div>
                    `;

                    reportsList.appendChild(reportDiv);
                }
            } catch (err) {
                console.error('Error loading reports:', err);
                reportsList.innerHTML = '<p>Error loading reports.</p>';
            }
        });

        // View Report Details
        async function viewReportDetails(reportId) {
            try {
                const report = await getFromIndexedDB(STORE_REPORTS, reportId);

                let detailsHTML = `
                    <h2>Report Details</h2>
                    <p><strong>Service Type:</strong> ${report.service_type || 'Unspecified'}</p>
                    <p><strong>Equipment ID:</strong> ${report.equipment_id || 'N/A'}</p>
                    <p><strong>Date:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                    <p><strong>Notes:</strong> ${report.notes || 'No notes'}</p>
                `;

                if (report.photos.length > 0) {
                    detailsHTML += '<h3>Photos:</h3><div class="thumbnail-grid">';
                    for (const photoId of report.photos) {
                        const photo = await getFromIndexedDB(STORE_PHOTOS, photoId);
                        if (photo) {
                            const url = URL.createObjectURL(photo.blob);
                            detailsHTML += `<img src="${url}" class="thumbnail" onclick="window.open('${url}')">`;
                        }
                    }
                    detailsHTML += '</div>';
                }

                if (report.videos.length > 0) {
                    detailsHTML += '<h3>Videos:</h3>';
                    for (const videoId of report.videos) {
                        const video = await getFromIndexedDB(STORE_VIDEOS, videoId);
                        if (video) {
                            const url = URL.createObjectURL(video.blob);
                            detailsHTML += `<video src="${url}" controls style="max-width: 100%; margin: 10px 0;"></video>`;
                        }
                    }
                }

                if (report.audio.length > 0) {
                    detailsHTML += '<h3>Audio:</h3>';
                    for (const audioId of report.audio) {
                        const audio = await getFromIndexedDB(STORE_AUDIO, audioId);
                        if (audio) {
                            const url = URL.createObjectURL(audio.blob);
                            detailsHTML += `<audio src="${url}" controls style="display: block; margin: 10px 0; width: 100%;"></audio>`;
                        }
                    }
                }

                document.getElementById('modalBody').innerHTML = detailsHTML;
                document.getElementById('reportModal').style.display = 'block';
            } catch (err) {
                console.error('Error viewing report:', err);
                alert('Error loading report details');
            }
        }

        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Export Report
        async function exportReport(reportId) {
            try {
                const report = await getFromIndexedDB(STORE_REPORTS, reportId);

                const exportData = {
                    ...report,
                    photos: [],
                    videos: [],
                    audio: []
                };

                for (const photoId of report.photos) {
                    const photo = await getFromIndexedDB(STORE_PHOTOS, photoId);
                    if (photo) {
                        const reader = new FileReader();
                        const base64 = await new Promise(resolve => {
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(photo.blob);
                        });
                        exportData.photos.push({
                            filename: photo.filename,
                            data: base64
                        });
                    }
                }

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `service_report_${reportId}_${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert('Report exported successfully!');
            } catch (err) {
                console.error('Error exporting report:', err);
                alert('Error exporting report');
            }
        }

        // Delete Report
        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report? This cannot be undone.')) {
                return;
            }

            try {
                const report = await getFromIndexedDB(STORE_REPORTS, reportId);

                for (const photoId of report.photos) {
                    await deleteFromIndexedDB(STORE_PHOTOS, photoId);
                }
                for (const videoId of report.videos) {
                    await deleteFromIndexedDB(STORE_VIDEOS, videoId);
                }
                for (const audioId of report.audio) {
                    await deleteFromIndexedDB(STORE_AUDIO, audioId);
                }

                await deleteFromIndexedDB(STORE_REPORTS, reportId);

                alert('Report deleted successfully');
                updateReportCount();
                document.getElementById('viewReports').click();
            } catch (err) {
                console.error('Error deleting report:', err);
                alert('Error deleting report');
            }
        }

        // Export All Data
        document.getElementById('exportAllData').addEventListener('click', async () => {
            try {
                const reports = await getAllFromIndexedDB(STORE_REPORTS);
                const exportData = [];

                for (const report of reports) {
                    const reportData = {
                        ...report,
                        photos: [],
                        videos: [],
                        audio: []
                    };

                    for (const photoId of report.photos) {
                        const photo = await getFromIndexedDB(STORE_PHOTOS, photoId);
                        if (photo) {
                            const reader = new FileReader();
                            const base64 = await new Promise(resolve => {
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(photo.blob);
                            });
                            reportData.photos.push({
                                filename: photo.filename,
                                data: base64
                            });
                        }
                    }

                    exportData.push(reportData);
                }

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `all_service_reports_${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert(`Exported ${exportData.length} reports successfully!`);
            } catch (err) {
                console.error('Error exporting all data:', err);
                alert('Error exporting data');
            }
        });

        // Clear All Data
        document.getElementById('clearAllData').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete ALL saved reports? This cannot be undone!')) {
                return;
            }

            if (!confirm('This will permanently delete all photos, videos, audio, and reports. Are you ABSOLUTELY sure?')) {
                return;
            }

            try {
                // Clear all object stores
                const transaction = db.transaction([STORE_REPORTS, STORE_PHOTOS, STORE_VIDEOS, STORE_AUDIO], 'readwrite');

                transaction.objectStore(STORE_REPORTS).clear();
                transaction.objectStore(STORE_PHOTOS).clear();
                transaction.objectStore(STORE_VIDEOS).clear();
                transaction.objectStore(STORE_AUDIO).clear();

                transaction.oncomplete = () => {
                    alert('All data cleared successfully');
                    updateReportCount();
                    document.getElementById('savedReportsSection').style.display = 'none';
                };
            } catch (err) {
                console.error('Error clearing data:', err);
                alert('Error clearing data');
            }
        });

        // Register service worker for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
